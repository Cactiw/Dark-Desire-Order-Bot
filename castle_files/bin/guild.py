"""
–í —ç—Ç–æ–º –º–æ–¥—É–ª–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≥–∏–ª—å–¥–∏—è–º–∏ –∫–∞–∫ —Å —Å—É—â–Ω–æ—Å—Ç—è–º–∏: —Å–æ–∑–¥–∞–Ω–∏–µ, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏ –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ
–æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –≥–∏–ª—å–¥–∏—è–º–∏, –∏ –∏–≥—Ä–æ–∫–∞–º–∏ –≤ –Ω–∏—Ö
"""
from castle_files.libs.guild import Guild
from castle_files.libs.player import Player

from castle_files.bin.buttons import get_edit_guild_buttons, get_general_buttons

from telegram.error import TelegramError

from castle_files.work_materials.globals import dispatcher
from telegram.ext.dispatcher import run_async


# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≥–∏–ª—å–¥–∏–∏
def create_guild(bot, update):
    guild_tag = update.message.text.partition(' ')[2]
    if len(guild_tag) <= 0 or len(guild_tag) > 3:
        bot.send_message(chat_id=update.message.chat_id, text="–ù–µ–≤–µ—Ä–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å. –£–∫–∞–∂–∏—Ç–µ —Ç—ç–≥ –Ω–æ–≤–æ–π –≥–∏–ª—å–¥–∏–∏.")
        return
    if any(c in guild_tag for c in ['\f', '\n', '\r', '\t', '\v', ' ']):
        bot.send_message(chat_id=update.message.chat_id, text="–ù–µ–≤–µ—Ä–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å. "
                                                              "–¢—ç–≥ –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã –∏–ª–∏ –∏–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏.")
        return
    guild = Guild.get_guild(guild_tag=guild_tag)
    if guild is not None:
        bot.send_message(chat_id=update.message.chat_id, text="–ì–∏–ª—å–¥–∏—è —Å —ç—Ç–∏–º —Ç—ç–≥–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!")
        return
    guild = Guild(None, guild_tag, None, None, None, None, None, None, None, None, None, None)
    guild.create_guild()
    bot.send_message(chat_id=update.message.chat_id, text="–ì–∏–ª—å–¥–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞! –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –µ—ë: "
                                                          "/edit_guild_{}".format(guild.id))
    return


# @dispatcher.run_async # –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
def guild_info(bot, update):
    mes = update.message
    player = Player.get_player(mes.from_user.id)
    if player is None:
        bot.send_message(chat_id=mes.chat_id, text="–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω. –û—Ç–ø—Ä–∞–≤—å—Ç–µ /hero –∏–∑ @ChatWarsBot.")
        return
    if player.guild is None:
        bot.send_message(chat_id=mes.chat_id, text="–í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –≥–∏–ª—å–¥–∏–∏. –í—Å—Ç—É–ø–∏—Ç–µ –≤ –≥–∏–ª—å–¥–∏—é –≤ –∏–≥—Ä–µ –∏ –ø–æ–ø—Ä–æ—Å–∏—Ç–µ "
                                                   "–∫–æ–º–∞–Ω–¥–∏—Ä–∞ –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –≤ –≥–∏–ª—å–¥–µ–π—Å–∫–æ–º —á–∞—Ç–µ.")
        return
    guild = Guild.get_guild(guild_id=player.guild)
    if guild is None:
        bot.send_message(chat_id=mes.chat_id, text="–ì–∏–ª—å–¥–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return
    commander = Player.get_player(guild.commander_id)
    response = "<b>{}</b>  {}\n".format(guild.tag, guild.name or "")
    response += "–ö–æ–º–∞–Ω–¥–∏—Ä: {}\n".format("@" + commander.username if commander is not None else "–ù–µ –∑–∞–¥–∞–Ω")
    response += "–ß–∞—Ç –æ—Ç—Ä—è–¥–∞: {}, id: {}" \
                "\n{}\n".format(guild.chat_name or "–ù–µ –∑–∞–¥–∞–Ω",
                              "<code>{}</code>".format(guild.chat_id) if guild.chat_id is not None else "–ù–µ –∑–∞–¥–∞–Ω",
                              "<a href=\"{}\">–í—Å—Ç—É–ø–∏—Ç—å</a>".format("https://t.me/joinchat/" + guild.invite_link)
                              if guild.invite_link is not None else "")

    response += "\n–ò–≥—Ä–æ–∫–æ–≤ –≤ –≥–∏–ª—å–¥–∏–∏: <b>{}</b>\n".format(guild.members_count)
    response += "‚öî: <b>{}</b>, üõ°: <b>{}</b>\n".format(guild.get_attack(), guild.get_defense())
    bot.send_message(chat_id=mes.chat_id, text=response, parse_mode='HTML')


# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ –≤ –≥–∏–ª—å–¥–∏—é
def add(bot, update):
    player = Player.get_player(update.message.from_user.id)
    if player is None:
        bot.send_message(chat_id=update.message.chat_id, text="–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ä–≤–∞—Ä–¥ /hero.")
        return
    guild = Guild.get_guild(guild_id=player.guild)
    if guild is None:
        bot.send_message(chat_id=update.message.chat_id, text="–ì–∏–ª—å–¥–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return
    if player.guild != guild.id:
        bot.send_message(chat_id=update.message.chat_id, text="–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∏–≥—Ä–æ–∫–æ–≤ —Ç–æ–ª—å–∫–æ –≤ —Å–≤–æ—é –≥–∏–ª—å–¥–∏—é")
        return
    if update.message.chat_id != guild.chat_id:
        bot.send_message(chat_id=update.message.chat_id, text="–î–æ–±–∞–≤–ª—è—Ç—å –∏–≥—Ä–æ–∫–æ–≤ –≤ –≥–∏–ª—å–¥–∏—é –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º "
                                                              "—á–∞—Ç–µ –≥–∏–ª—å–¥–∏–∏")
        return
    if player.id != guild.commander_id and player.id not in guild.assistants:
        bot.send_message(chat_id=update.message.chat_id, text="–¢–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥–∏—Ä –∏ –µ–≥–æ –∑–∞–º—ã –º–æ–≥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –±–æ–π—Ü–æ–≤.")
        return
    if update.message.reply_to_message is None:
        bot.send_message(chat_id=update.message.chat_id, text="–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —è–≤–ª—è—Ç—å—Å—è –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞, "
                                                              "–∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –≥–∏–ª—å–¥–∏—é.")
        return
    player_to_add = Player.get_player(update.message.reply_to_message.from_user.id)
    if player_to_add is None:
        bot.send_message(chat_id=update.message.chat_id, text="–ò–≥—Ä–æ–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return
    if player_to_add.guild is not None:
        bot.send_message(chat_id=update.message.chat_id, text="–ò–≥—Ä–æ–∫ —É–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –≥–∏–ª—å–¥–∏–∏.")
        return
    guild.add_player(player_to_add)

    bot.send_message(chat_id=update.message.chat_id, text="<b>{}</b> —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥–∏–ª—å–¥–∏—é "
                                                          "<b>{}</b>".format(player_to_add.nickname, guild.tag),
                     parse_mode='HTML')


# –ö–æ–º–∞–Ω–¥–∞ /edit_guild
def edit_guild(bot, update):
    mes = update.message
    try:
        guild_id = int(mes.text.partition("@")[0].split("_")[2])
    except ValueError:
        bot.send_message(chat_id=mes.chat_id, text="–ù–µ–≤–µ—Ä–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å")
        return
    guild = Guild.get_guild(guild_id=guild_id)
    if guild is None:
        bot.send_message(chat_id=mes.chat_id, text="–ì–∏–ª—å–¥–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    response = "–ì–∏–ª—å–¥–∏—è <b>{}</b>\n".format(guild.tag)
    if guild.commander_id is not None:
        commander = Player.get_player(guild.commander_id)
    else:
        commander = None
    response += "–ö–æ–º–∞–Ω–¥–∏—Ä: {}\n".format("@" + commander.username if commander is not None else "–ù–µ –∑–∞–¥–∞–Ω")
    response += "–ß–∞—Ç –æ—Ç—Ä—è–¥–∞: {}, id: {}" \
                "\n{}".format(guild.chat_name or "–ù–µ –∑–∞–¥–∞–Ω",
                              "<code>{}</code>".format(guild.chat_id) if guild.chat_id is not None else "–ù–µ –∑–∞–¥–∞–Ω",
                              "<a href=\"{}\">–í—Å—Ç—É–ø–∏—Ç—å</a>".format("https://t.me/joinchat/" + guild.invite_link)
                              if guild.invite_link is not None else "")
    bot.send_message(chat_id=mes.chat_id, text=response, parse_mode='HTML', reply_markup=get_edit_guild_buttons(guild))
    return


# –ù–∞–∂–∞—Ç–∏–µ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏ "–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥–∏—Ä–∞"
def edit_guild_commander(bot, update, user_data):
    try:
        user_data.update({"status": "edit_guild_commander", "edit_guild_id": int(update.callback_query.data.split("_")[1])})
    except ValueError:
        bot.send_message(chat_id=update.callback_query.message.chat_id, text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞")
    else:
        bot.send_message(chat_id=update.callback_query.message.chat_id, text="–í–≤–µ–¥–∏—Ç–µ id –Ω–æ–≤–æ–≥–æ –∫–æ–º–∞–Ω–¥–∏—Ä–∞ –≥–∏–ª—å–¥–∏–∏, "
                                                                             "–∏–ª–∏ –Ω–∞–±–µ—Ä–∏—Ç–µ /cancel –¥–ª—è –æ—Ç–º–µ–Ω—ã")
    bot.answerCallbackQuery(callback_query_id=update.callback_query.id)


# –í–≤–æ–¥ id –∫–æ–º–∞–Ω–¥–∏—Ä–∞
def change_guild_commander(bot, update, user_data):
    mes = update.message
    try:
        player_id = int(mes.text)
    except ValueError:
        bot.send_message(chat_id=mes.chat_id, text="–ù–µ–≤–µ—Ä–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å.")
        return
    player = Player.get_player(player_id)
    if player is None:
        bot.send_message(chat_id=mes.chat_id, text="–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞ id.")
        return
    guild_id = user_data.get("edit_guild_id")
    guild = None
    if guild_id is not None:
        guild = Guild.get_guild(guild_id=guild_id)
    if guild_id is None or guild is None:
        bot.send_message(chat_id=mes.chat_id, text="–ì–∏–ª—å–¥–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ù–∞—á–Ω–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞.")
        return
    print(player.guild_tag, player.guild_tag, guild.tag)
    if player.guild_tag is not None and player.guild_tag != guild.tag:
        bot.send_message(chat_id=mes.chat_id, text="–ö–æ–º–∞–Ω–¥–∏—Ä –º–æ–∂–µ—Ç –∫–æ–º–∞–Ω–¥–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–π –≥–∏–ª—å–¥–∏–µ–π")
        return
    if player.guild_tag is None or player.guild is None:
        player.guild_tag = guild.tag
        player.guild = guild.id
        player.update()
    guild.commander_id = player_id
    if guild.members is None:
        guild.members = []
    if player.id not in guild.members:
        guild.members.append(player.id)
    guild.update_to_database()
    if "status" in user_data:
        user_data.pop("status")
    if "edit_guild_id" in user_data:
        user_data.pop("edit_guild_id")
    bot.send_message(chat_id=update.message.chat_id, text="–ö–æ–º–∞–Ω–¥–∏—Ä–æ–º –≥–∏–ª—å–¥–∏–∏ <b>{}</b> –Ω–∞–∑–Ω–∞—á–µ–Ω <b>{}</b> "
                                                          "{}".format(guild.tag, player.nickname,
                                                                      "(@{})".format(player.username)
                                                                      if player.username is not None else ""),
                     parse_mode='HTML')


# –ù–∞–∂–∞—Ç–∏–µ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏ "–ò–∑–º–µ–Ω–∏—Ç—å —á–∞—Ç –≥–∏–ª—å–¥–∏–∏"
def edit_guild_chat(bot, update, user_data):
    try:
        user_data.update(
            {"status": "edit_guild_chat", "edit_guild_id": int(update.callback_query.data.split("_")[1])})
    except ValueError:
        bot.send_message(chat_id=update.callback_query.message.chat_id, text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞")
    else:
        bot.send_message(chat_id=update.callback_query.message.chat_id, text="–í–≤–µ–¥–∏—Ç–µ id –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ –≥–∏–ª—å–¥–∏–∏, "
                                                                             "–∏–ª–∏ –Ω–∞–±–µ—Ä–∏—Ç–µ /cancel –¥–ª—è –æ—Ç–º–µ–Ω—ã")
    bot.answerCallbackQuery(callback_query_id=update.callback_query.id)


# –í–≤–æ–¥ –∞–π–¥–∏ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ –≥–∏
def change_guild_chat(bot, update, user_data):
    mes = update.message
    try:
        chat_id = int(mes.text)
    except ValueError:
        bot.send_message(chat_id=mes.chat_id, text="–ù–µ–≤–µ—Ä–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å.")
        return
    guild_id = user_data.get("edit_guild_id")
    guild = None
    if guild_id is not None:
        guild = Guild.get_guild(guild_id=guild_id)
    if guild_id is None or guild is None:
        bot.send_message(chat_id=mes.chat_id, text="–ì–∏–ª—å–¥–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ù–∞—á–Ω–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞.")
        return
    try:
        message = bot.sync_send_message(chat_id=chat_id, text="–≠—Ç–æ —Ç–µ–ø–µ—Ä—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —á–∞—Ç –≥–∏–ª—å–¥–∏–∏ "
                                                              "<b>{}</b>".format(guild.tag), parse_mode='HTML')
        chat = bot.getChat(message.chat_id)
        if chat is None:
            bot.send_message(chat_id=update.message.chat_id, text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ id "
                                                                  "–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –±–æ—Ç–∞ –≤ —ç—Ç–æ–º —á–∞—Ç–µ")
            return
    except TelegramError:
        bot.send_message(chat_id=update.message.chat_id, text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ id "
                                                              "–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –±–æ—Ç–∞ –≤ —ç—Ç–æ–º —á–∞—Ç–µ")
        return
    guild.chat_id = chat.id
    guild.chat_name = chat.title
    try:
        guild.invite_link = bot.exportChatInviteLink(chat_id)
        if guild.invite_link is not None:
            guild.invite_link = guild.invite_link[22:]  # –û–±—Ä–µ–∑–∞—é https://t.me/joinchat/
    except TelegramError:
        pass
    guild.update_to_database()
    bot.send_message(chat_id=mes.chat_id, text="–ß–∞—Ç –≥–∏–ª—å–¥–∏–∏ <b>{}</b> —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω "
                                               "–Ω–∞ <b>{}</b>".format(guild.tag, guild.chat_name or guild.chat_id),
                     parse_mode='HTML')


# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ –≤ –ª—Å
def chat_info(bot, update):
    response = "<b>{}</b>, id: <code>{}</code>".format(update.message.chat.title, update.message.chat_id)
    bot.send_message(chat_id=update.message.from_user.id, text=response, parse_mode='HTML')
