"""
–ó–¥–µ—Å—å –Ω–∞—Ö–æ–¥—è—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π, —Å–≤—è–∑–∞–Ω–Ω—Ö —Å –º–æ–±–∞–º–∏
"""

from castle_files.work_materials.globals import MOB_CHAT_ID, moscow_tz, utc, cursor
from castle_files.work_materials.filters.general_filters import filter_is_pm

from castle_files.libs.player import Player
from castle_files.libs.guild import Guild
from castle_files.libs.castle.location import Location

import datetime
import re
import logging
import traceback
import requests
import json

import psycopg2

from telegram import InlineKeyboardButton, InlineKeyboardMarkup

PING_LIMIT = 4


def get_mobs_text_and_buttons(link, mobs, lvls, helpers, forward_message_date, buffs, minutes):
    response = "–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –º–æ–±—ã{}:\n".format(", –∑–∞—Å–∞–¥–∞!" if minutes == 5 else "")
    avg_lvl = 0
    for i, name in enumerate(mobs):
        lvl = lvls[i]
        avg_lvl += lvl
        response += "<b>{}</b> üèÖ: <code>{}</code>\n{}".format(name, lvl, "  ‚ï∞ {}\n".format(buffs[i]) if buffs[i] != ""
                                                              else "")
    avg_lvl /= len(lvls)
    if helpers:
        response += "\n" + get_helpers_text(helpers)

    now = datetime.datetime.now(tz=moscow_tz).replace(tzinfo=None)
    remaining_time = datetime.timedelta(minutes=minutes) - (now - forward_message_date)
    if remaining_time < datetime.timedelta(0):
        response += "\n–í—Ä–µ–º–µ–Ω–∏ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å!"
    else:
        response += "\n–û—Å—Ç–∞–ª–æ—Å—å: <b>{}</b>".format("{:02d}:{:02d}".format(int(remaining_time.total_seconds() // 60),
                                                                          int(remaining_time.total_seconds() % 60)))
    buttons = [[InlineKeyboardButton(text="‚öî {}-{}üèÖ".format(int(avg_lvl - 5), int(avg_lvl + 10)),
                                     url=u"https://t.me/share/url?url=/fight_{}".format(link)),
                InlineKeyboardButton(text="ü§ù–ü–æ–º–æ–≥–∞—é!", callback_data="mob_partify_{}".format(link))]]
    if len(helpers) >= 5:
        buttons[0].pop(1)
    return [response, InlineKeyboardMarkup(buttons), avg_lvl]


def mob(bot, update):
    mes = update.message
    link = re.search("/fight_(.*)$", mes.text)
    if link is None:
        bot.send_message(chat_id=mes.chat_id, text="–û—à–∏–±–∫–∞.")
        return
    link = link.group(1)
    names, lvls, buffs = [], [], []
    for string in mes.text.splitlines():
        parse = re.search("(.+) lvl\\.(\\d+)", string)
        if parse is not None:
            name = parse.group(1)
            lvl = int(parse.group(2))
            names.append(name)
            lvls.append(lvl)
            buffs.append("")
        else:
            parse = re.search("  ‚ï∞ (.+)", string)
            if parse is not None:
                buff = parse.group(1)
                buffs.pop()
                buffs.append(buff)
    try:
        forward_message_date = utc.localize(mes.forward_date).astimezone(tz=moscow_tz).replace(tzinfo=None)
    except Exception:
        forward_message_date = datetime.datetime.now(tz=moscow_tz).replace(tzinfo=None)
    request = "insert into mobs(link, mob_names, mob_lvls, date_created, created_player, on_channel, buffs) values (" \
              "%s, %s, %s, %s, %s, %s, %s)"
    is_pm = filter_is_pm(mes)
    helpers = []
    try:
        cursor.execute(request, (link, names, lvls, forward_message_date, mes.from_user.id, is_pm, buffs))
    except psycopg2.IntegrityError:
        # logging.error(traceback.format_exc())
        request = "select on_channel, helpers from mobs where link = %s"
        cursor.execute(request, (link,))
        row = cursor.fetchone()
        helpers = row[1]
        if is_pm:
            if row[0]:
                bot.send_message(chat_id=mes.chat_id, text="–î–∞–Ω–Ω—ã–π –º–æ–± —É–∂–µ –Ω–∞ –∫–∞–Ω–∞–ª–µ",
                                 reply_to_message_id=mes.message_id)
                return
            request = "update mobs set on_channel = true where link = %s"
            cursor.execute(request, (link,))
    minutes = 5 if 'ambush' in mes.text else 3
    response, buttons, avg_lvl = get_mobs_text_and_buttons(link, names, lvls, helpers, forward_message_date, buffs,
                                                           minutes)
    player = Player.get_player(mes.from_user.id)
    if is_pm and (player is None or player.castle == 'üñ§'):
        if 'It\'s an ambush!'.lower() in mes.text.lower():
            bot.send_message(chat_id=mes.chat_id, text="–ó–∞—Å–∞–¥—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ –∫–∞–Ω–∞–ª. "
                                                       "–ó–æ–≤–∏—Ç–µ –±–æ–π—Ü–æ–≤ –≤–∞—à–µ–π –≥–∏–ª—å–¥–∏–∏ –Ω–∞ –ø–æ–º–æ—â—å!")
        else:
            bot.send_message(chat_id=MOB_CHAT_ID, text=response, parse_mode='HTML', reply_markup=buttons)
            bot.send_message(chat_id=mes.chat_id, text="–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –∫–∞–Ω–∞–ª. –°–ø–∞—Å–∏–±–æ!")
            try:
                # requests.post('http://127.0.0.1:5555/addMob',
                #               json=json.dumps({"castle": 'üñ§', "text": mes.text, "telegram_id": mes.from_user.id,
                #                                "forward_date": forward_message_date.timestamp()}, ensure_ascii=False),
                #               timeout=0.3)

                pass
                # –í–µ—Ä–Ω–æ!
                requests.post('http://ec2-18-184-54-121.eu-central-1.compute.amazonaws.com:5555/addMob',
                              json=json.dumps({"castle": 'üñ§', "text": mes.text, "telegram_id": mes.from_user.id,
                                               "forward_date": forward_message_date.timestamp()}, ensure_ascii=False),
                              timeout=0.3)
            except Exception:
                logging.error(traceback.format_exc())
    else:
        ping_count = 0
        if not is_pm:
            barracks = Location.get_location(1)
            try:
                ping_list = barracks.special_info.get("mobs_notify").get(str(mes.chat_id)).copy()
            except Exception:
                ping_list = None
            if not ping_list:
                ping_list = []
            if player.guild is not None or ping_list:
                guild = Guild.get_guild(guild_id=player.guild)
                if guild is not None and guild.chat_id == mes.chat_id:
                    ping_list += guild.members
                if ping_list:
                    ping = []
                    for pl_id in ping_list:
                        pl = Player.get_player(pl_id)
                        if avg_lvl - 5 <= pl.lvl <= avg_lvl + 10:
                            on = pl.settings.get("mobs_notify")
                            if on is None:
                                on = True
                            if on and pl.id != mes.from_user.id:
                                ping.append(pl.username)
                    if ping:
                        text = "–ú–æ–±—ã!\n"
                        for username in ping:
                            text += "@{} ".format(username)
                            ping_count += 1
                            if ping_count >= PING_LIMIT:
                                bot.send_message(chat_id=mes.chat_id, text=text)
                                text = "–ú–æ–±—ã!\n"
                                ping_count = 0
                        if text != "–ú–æ–±—ã!\n":
                            bot.send_message(chat_id=mes.chat_id, text=text)
        bot.send_message(chat_id=mes.chat_id, text=response, parse_mode='HTML', reply_markup=buttons)
    return


def get_helpers_text(helpers):
    response = "–ü–æ–º–æ—â–Ω–∏–∫–∏:\n"
    for username in helpers:
        response += "@{}\n".format(username)
    return response


def mob_help(bot, update):
    data = update.callback_query.data
    mes = update.callback_query.message
    link = re.search("mob_partify_(.+)", data)
    if link is None:
        bot.send_message(chat_id=update.callback_query.from_user.id, text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.")
        return
    link = link.group(1)
    request = "select mob_names, mob_lvls, date_created, helpers, buffs from mobs where link = %s"
    cursor.execute(request, (link,))
    row = cursor.fetchone()
    if row is None:
        bot.send_message(chat_id=update.callback_query.from_user.id, text="–°–æ–±—ã—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
        return
    names, lvls, forward_message_date, helpers, buffs = row
    if update.callback_query.from_user.username in helpers:
        bot.answerCallbackQuery(callback_query_id=update.callback_query.id, text="–¢—ã —É–∂–µ –ø–æ–º–æ–≥!", show_alert=True)
        return
    if len(helpers) >= 5:
        bot.answerCallbackQuery(callback_query_id=update.callback_query.id, text="–£–∂–µ —Å–æ–±—Ä–∞–ª–æ—Å—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–º–æ—â–Ω–∏–∫–æ–≤!",
                                show_alert=True)
    else:
        helpers.append(update.callback_query.from_user.username)
    minutes = 5 if '–∑–∞—Å–∞–¥–∞' in mes.text else 3
    response, buttons, avg_lvl = get_mobs_text_and_buttons(link, names, lvls, helpers, forward_message_date, buffs, minutes)

    try:
        bot.editMessageText(chat_id=mes.chat_id, message_id=mes.message_id, text=response,
                            reply_markup=buttons, parse_mode='HTML')
    except Exception:
        logging.error(traceback.format_exc())
    bot.answerCallbackQuery(callback_query_id=update.callback_query.id, text="–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ")
    request = "update mobs set helpers = %s where link = %s"
    cursor.execute(request, (helpers, link))


def get_fight_club_txt(link, lvl, helpers, forward_message_date):
    response = "–ü–æ–¥–ø–æ–ª—å–Ω—ã–π –±–æ–π!\nüèÖ–£—Ä–æ–≤–µ–Ω—å: <b>{}</b>\n".format(lvl)
    if helpers:
        response += "\n"
        for username in helpers:
            response += "{}\n".format(username)

    now = datetime.datetime.now(tz=moscow_tz).replace(tzinfo=None)
    remaining_time = datetime.timedelta(minutes=3) - (now - forward_message_date)
    if remaining_time < datetime.timedelta(0):
        response += "\n–í—Ä–µ–º–µ–Ω–∏ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å!"
    else:
        response += "\n–û—Å—Ç–∞–ª–æ—Å—å: <b>{}</b>".format("{:02d}:{:02d}".format(int(remaining_time.total_seconds() // 60),
                                                                          int(remaining_time.total_seconds() % 60)))
    return response


def fight_club(bot, update):
    mes = update.message
    link = re.search("/fight_(.*)$", mes.text)
    if link is None:
        bot.send_message(chat_id=mes.chat_id, text="–û—à–∏–±–∫–∞.")
        return
    link = link.group(1)
    player = Player.get_player(mes.from_user.id)
    try:
        forward_message_date = utc.localize(mes.forward_date).astimezone(tz=moscow_tz).replace(tzinfo=None)
    except Exception:
        forward_message_date = datetime.datetime.now(tz=moscow_tz).replace(tzinfo=None)
    request = "select mob_lvls, helpers from mobs where link = %s"
    cursor.execute(request, (link,))
    row = cursor.fetchone()
    helpers = []
    lvl = player.lvl
    if row is not None:
        lvls, helpers = row
        lvl = lvls[0]
    response = get_fight_club_txt(link, lvl, helpers, forward_message_date)
    buttons = [[InlineKeyboardButton(text="‚öî {}-{}üèÖ".format(int(lvl - 5), int(lvl + 10)),
                                     url=u"https://t.me/share/url?url=/fight_{}".format(link)),
                InlineKeyboardButton(text="ü§ù–ü–æ–º–æ–≥–∞—é!", callback_data="fight_club_partify_{}".format(link))]]
    guild = Guild.get_guild(chat_id=mes.chat_id)
    if guild is not None:
        ping = []
        for player_id in guild.members:
            cur_player = Player.get_player(player_id)
            if cur_player is None:
                continue
            if cur_player.settings.get("pretend") and cur_player.lvl in range(lvl - 5, lvl + 11):
                ping.append(player.username)
            if len(ping) >= 4:
                text = "–ü–æ–¥–ø–æ–ª—å–Ω—ã–π –±–æ–π!\n"
                for username in ping:
                    text += "@{} ".format(username)
                bot.send_message(chat_id=mes.chat_id, text=text)
                ping.clear()
        if ping:
            text = "–ü–æ–¥–ø–æ–ª—å–Ω—ã–π –±–æ–π!\n"
            for username in ping:
                text += "@{} ".format(username)
            bot.send_message(chat_id=mes.chat_id, text=text)
    if guild is not None:
        response += "\n\n<em>–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫–ª—É–±–∞—Ö –≤ —á–∞—Ç–µ –≥–∏:</em> /pretend"
    bot.send_message(chat_id=mes.chat_id, text=response, reply_markup=InlineKeyboardMarkup(buttons), parse_mode='HTML')
    request = "insert into mobs(link, mob_names, mob_lvls, date_created, created_player) values (" \
              "%s, %s, %s, %s, %s)"
    try:
        cursor.execute(request, (link, ["Fight Club"], [lvl], forward_message_date, mes.from_user.id))
    except psycopg2.IntegrityError:
        pass


def fight_club_help(bot, update):
    data = update.callback_query.data
    mes = update.callback_query.message
    link = re.search("fight_club_partify_(.+)", data)
    if link is None:
        bot.send_message(chat_id=update.callback_query.from_user.id, text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.")
        return
    link = link.group(1)
    request = "select mob_lvls, date_created, helpers from mobs where link = %s"
    cursor.execute(request, (link,))
    row = cursor.fetchone()
    if row is None:
        bot.send_message(chat_id=update.callback_query.from_user.id, text="–°–æ–±—ã—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
        return
    lvls, forward_message_date, helpers = row
    lvl = lvls[0]
    player = Player.get_player(update.callback_query.from_user.id)
    if player is None:
        bot.answerCallbackQuery(callback_query_id=update.callback_query.id, text="–î–ª—è –ø–æ–º–æ—â–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è!",
                                show_alert=True)
        return
    helper_row = "@{} üèÖ:{}".format(player.username, player.lvl)
    if helper_row in helpers:
        bot.answerCallbackQuery(callback_query_id=update.callback_query.id, text="–¢—ã —É–∂–µ –ø–æ–º–æ–≥–∞–µ—à—å!", show_alert=True)
        return
    helpers.append(helper_row)
    response = get_fight_club_txt(link, lvl, helpers, forward_message_date)
    buttons = [[InlineKeyboardButton(text="‚öî {}-{}üèÖ".format(int(player.lvl - 5), int(player.lvl + 10)),
                                     url=u"https://t.me/share/url?url=/fight_{}".format(link)),
                InlineKeyboardButton(text="ü§ù–ü–æ–º–æ–≥–∞—é!", callback_data="fight_club_partify_{}".format(link))]]
    try:
        bot.editMessageText(chat_id=mes.chat_id, message_id=mes.message_id, text=response,
                            reply_markup=InlineKeyboardMarkup(buttons), parse_mode='HTML')
    except Exception:
        logging.error(traceback.format_exc())
    bot.answerCallbackQuery(callback_query_id=update.callback_query.id, text="–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ")
    request = "update mobs set helpers = %s where link = %s"
    cursor.execute(request, (helpers, link))


def pretend(bot, update):
    mes = update.message
    player = Player.get_player(mes.from_user.id)
    current = player.settings.get("pretend")
    if current is None:
        current = False
    current = not current
    player.settings.update({"pretend": current})
    player.update()
    bot.send_message(chat_id=mes.chat_id,
                     text="–ü–∏–Ω–≥–∏ –Ω–∞ –ø–æ–¥–ø–æ–ª—å–Ω—ã–µ –±–æ–∏ <b>{}</b>".format("‚úÖ–≤–∫–ª—é—á–µ–Ω—ã" if current else "‚ùå–æ—Ç–∫–ª—é—á–µ–Ω—ã"),
                     parse_mode='HTML')
    return


def mobs_notify(bot, update):
    mes = update.message
    player = Player.get_player(mes.from_user.id)
    barracks = Location.get_location(1)
    chats = barracks.special_info.get("mobs_notify")
    if chats is None:
        chats = {}
        barracks.special_info.update({"mobs_notify": chats})
    current = chats.get(str(mes.chat_id))
    if current is None:
        current = []
        chats.update({str(mes.chat_id): current})
    try:
        current.remove(player.id)
        bot.send_message(chat_id=mes.chat_id,
                         text="<b>{}</b> —É–¥–∞–ª—ë–Ω –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–∏–Ω–≥–∞ —á–∞—Ç–∞ –Ω–∞ –º–æ–±–æ–≤.".format(player.nickname),
                         parse_mode='HTML')
    except ValueError:
        current.append(player.id)
        bot.send_message(chat_id=mes.chat_id,
                         text="<b>{}</b> –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫ –ø–∏–Ω–≥–∞ —á–∞—Ç–∞ –Ω–∞ –º–æ–±–æ–≤.".format(player.nickname),
                         parse_mode='HTML')
    barracks.update_location_to_database()


